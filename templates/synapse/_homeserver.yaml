{{- define "homeserver.yaml" }}
{{- if .Values.matrix.homeserverOverride }}
{{- toYaml .Values.matrix.homeserverOverride }}
{{- else }}

server_name: {{ .Values.matrix.serverName }}

pid_file: /data/homeserver.pid
public_baseurl: {{ include "matrix.baseUrl" . | quote }}
use_presence: {{ .Values.matrix.presence }}
allow_public_rooms_over_federation: {{ and .Values.matrix.federation.enabled .Values.matrix.federation.allowPublicRooms }}
block_non_admin_invites: {{ .Values.matrix.blockNonAdminInvites }}
enable_search: {{ .Values.matrix.search }}

{{- if .Values.matrix.federation.whitelist }}
federation_domain_whitelist:
    {{- range .Values.matrix.federation.whitelist }}
    - {{ . }}
    {{- end }}
{{- end}}

federation_ip_range_blacklist:
{{- range .Values.matrix.federation.blacklist }}
    - {{ . }}
{{- end }}

listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']

    resources:
      - names: [client, federation]
        compress: false

{{- if .Values.synapse.metrics.enabled }}
  - type: metrics
    port: {{ .Values.synapse.metrics.port }}
    bind_addresses: ['0.0.0.0']

    resources:
      - names: [metrics]
{{- end }}

admin_contact: 'mailto:{{ .Values.matrix.adminEmail }}'

hs_disabled: {{ .Values.matrix.disabled }}
hs_disabled_message: {{ .Values.matrix.disabledMessage }}
redaction_retention_period: {{ .Values.matrix.retentionPeriod }}

database:
    name: "{{ .Values.matrix.db.engine }}"

  {{- if eq .Values.matrix.db.engine "sqlite3" }}
    args:
      database: /data/db/homeserver.db
  {{- else if eq .Values.matrix.db.driver "postgres" }}
    # Arguments to pass to the engine
    args:
        user: "{{ .Values.postgresql.username }}"
        password: "{{ .Values.postgresql.password }}"
        database: "{{ .Values.postgresql.database }}"

        {{- if .Values.postgresql.enabled }}
        host: "{{ include "matrix.fullname" . }}-postgresql"
        port: "5432"
        {{- else }}
        host: "{{ .Values.postgresql.hostname }}"
        port: "{{ .Values.postgresql.port }}"
        {{- end }}
        sslmode: {{ .Values.postgresql.sslMode }}
        cp_min: 5
        cp_max: 10
  {{- end }}

log_config: "/data/{{ .Values.matrix.serverName }}.log.config"
media_store_path: "/data/media_store"
uploads_path: "/data/uploads"
max_upload_size: {{ .Values.matrix.uploads.maxSize }}
max_image_pixels: {{ .Values.matrix.uploads.maxPixels }}
url_preview_enabled: {{ .Values.matrix.urlPreviews.enabled }}

{{- if .Values.matrix.urlPreviews.rules.ip.blacklist }}
url_preview_ip_range_blacklist:
    {{- range .Values.matrix.urlPreviews.rules.ip.blacklist }}
    - {{ . }}
    {{- end }}
{{- end }}

{{- if .Values.matrix.urlPreviews.rules.ip.whitelist }}
url_preview_ip_range_whitelist:
    {{- range .Values.matrix.urlPreviews.rules.ip.whitelist}}
    - {{ . }}
    {{- end }}
{{- end }}

{{- if .Values.matrix.urlPreviews.rules.url.blacklist }}
url_preview_url_blacklist:
{{ include .Values.matrix.urlPreviews.rules.url.blacklist . | nindent 2 }}
{{- end }}

max_spider_size: {{ .Values.matrix.urlPreviews.rules.maxSize }}

## Registration ##
#
enable_registration: {{ .Values.matrix.registration.enabled }}

{{- if .Values.matrix.registration.required3Pids }}
registrations_require_3pid:
    {{- range .Values.matrix.registration.required3Pids }}
    - {{ . }}
    {{- end }}
{{- end }}

{{- if .Values.matrix.registration.sharedSecret }}
registration_shared_secret: {{ .Values.matrix.registration.sharedSecret }}
{{- end }}

allow_guest_access: {{ .Values.matrix.registration.allowGuests }}

account_threepid_delegates:

{{- if not (empty .Values.matrix.autoJoinRooms) }}
auto_join_rooms:
    {{- range .Values.matrix.autoJoinRooms }}
    - {{ . }}
    {{- end }}
{{- end }}

{{- if .Values.synapse.metrics.enabled }}
enable_metrics: true
{{- end }}

## Signing Keys ##

# Path to the signing key to sign messages with
#
signing_key_path: "/data/keys/{{ .Values.matrix.serverName }}.signing.key"

{{- if .Values.matrix.security.trustedKeyServers }}
trusted_key_servers:
    {{- range .Values.matrix.security.trustedKeyServers }}
    - server_name: {{ .serverName }}
      {{- if .verifyKeys }}
      verify_keys:
        {{- range .verifyKeys }}
          {{ .id | quote }}: {{ .key | quote }}
        {{- end }}
      {{- end }}
      {{- if .acceptKeysInsecurely }}
      accept_keys_insecurely: {{ .acceptKeysInsecurely }}
      {{- end }}
    {{- end }}
{{- end }}

# Uncomment the following to disable the warning that is emitted when the
# trusted_key_servers include 'matrix.org'. See above.
#
suppress_key_server_warning: {{ .Values.matrix.security.supressKeyServerWarning }}
encryption_enabled_by_default_for_room_type: {{ .Values.matrix.encryptByDefault }}
report_stats: false

log_config: /app/config/log.config

{{ if .Values.matrix.homeserverExtra }}
{{- toYaml .Values.matrix.homeserverExtra }}
{{- end }}
{{- end }}
{{- end }}
